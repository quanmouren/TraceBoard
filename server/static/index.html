<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>键盘按键统计</title>
    <style>
        html, body, div {
            margin: 0;
            padding: 0;
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
        }
        .tooltip {
            display: none;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }

        
        .container {
            width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;          
            justify-content: center;
            align-items: center;
            background-color: #000033;
            padding: 28px 18px 40px;         
            box-sizing: border-box;
            gap: 20px;                       
        }

        
        .keyboard {
            display: flex;
            border-radius: 10px;
            box-shadow: 0px 0px 20px 1px #666 inset, 0px 0px 5px 1px #fff;
            background-color: #E4E6EA;
            padding: 30px;
        }

        
        .key {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: #E4E9EC;
            box-shadow: 3px 3px 8px 2px #999, -3px -3px 8px 2px #fff;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: .1s;
        }
        .key:hover, .active { box-shadow: 0 0 3px 1px #999; }

        
        .key-empty { width: 40px; height: 40px; }

        
        .key-bubble {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            background-color: #009999;
            color: #fff;
            font-size: 13px;
            position: absolute;
            transition: all 2s ease-in-out;
            overflow: hidden;
            box-shadow: 0 0 10px 1px #000, 0 0 10px 1px #fff inset;
        }

        
        .area-1 {
            width: 740px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: baseline;
        }

        
        .area-2 {
            width: 140px;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .area-2-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        
        .area-3 {
            width: 190px;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .area-3-light { display: flex; gap: 10px; }
        .area-3-light-item {
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            color: #999;
        }
        .area-3-number { display: flex; gap: 10px; }
        .area-3-number-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        
        .dashboard {
            width: min(1120px, 100%);        
            display: grid;
            grid-template-columns: 1fr;      
            gap: 14px;
            box-sizing: border-box;
        }

        .panel {
            background: rgba(255,255,255,0.70);
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
        .panel-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .subtle {
            font-size: 12px;
            color: rgba(0,0,0,0.55);
            font-weight: 500;
        }

        .heatmap { user-select: none; }
        .heatmap-grid {
            display: flex;
            gap: 3px;
            align-items: flex-start;
            overflow-x: auto;
            padding-bottom: 6px;
        }
        .heatmap-week {
            display: grid;
            grid-template-rows: repeat(7, 12px);
            gap: 3px;
        }
        .heat-cell {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            background: rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .heat-cell:hover { outline: 2px solid rgba(0,0,0,0.14); }

        .heatmap-month-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 8px;
        }
        .month-cell {
            height: 44px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.06);
            background: rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 8px 10px;
        }
        .month-label { font-size: 12px; font-weight: 700; }
        .month-value {
            font-size: 12px;
            color: rgba(0,0,0,0.6);
            margin-top: 2px;
        }

        .hotkey-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        select {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.12);
            background: rgba(255,255,255,0.9);
            outline: none;
        }
        .btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.12);
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            font-weight: 700;
        }
        .btn:active { transform: translateY(1px); }

        .hotkey-list {
            margin-top: 10px;
            display: grid;
            gap: 6px;
            font-size: 12px;
            color: rgba(0,0,0,0.7);
        }
        .hotkey-item {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(0,0,0,0.06);
        }

        
@media (max-width: 980px) {
            .heatmap-month-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    

.mode-link{
    cursor: pointer;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.12);
    background: rgba(255,255,255,0.55);
    font-size: 12px;
    color: rgba(0,0,0,0.65);
    user-select: none;
    transition: .12s;
}
.mode-link:hover{
    background: rgba(255,255,255,0.8);
}
.mode-link.active{
    background: rgba(0,0,0,0.08);
    color: rgba(0,0,0,0.8);
    border-color: rgba(0,0,0,0.18);
}
.mode-sep{ margin: 0 6px; color: rgba(0,0,0,0.35); }


.hourly-grid{
    display: grid;
    grid-template-columns: repeat(24, 12px);
    gap: 3px;
    align-items: end;
    overflow-x: auto;
    padding-bottom: 6px;
}
.hour-cell{
    width: 12px;
    height: 24px;
    border-radius: 3px;
    background: rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.05);
}
.hour-cell:hover{ outline: 2px solid rgba(0,0,0,0.14); }

    </style>
</head>
<body>
    <div class="container">
                <div class="keyboard">
                        <div class="area-1">
                                <div class="key" id="k27">Esc</div>
                <div class="key" id="k112" style="margin-left: 50px;">F1</div>
                <div class="key" id="k113">F2</div>
                <div class="key" id="k114">F3</div>
                <div class="key" id="k115" style="margin-right: 25px;">F4</div>
                <div class="key" id="k116">F5</div>
                <div class="key" id="k117">F6</div>
                <div class="key" id="k118">F7</div>
                <div class="key" id="k119" style="margin-right: 25px;">F8</div>
                <div class="key" id="k120">F9</div>
                <div class="key" id="k121">F10</div>
                <div class="key" id="k122">F11</div>
                <div class="key" id="k123">F12</div>

                                <div class="key" id="k192"><span>~</span><span>`</span></div>
                <div class="key" id="k49"><span>!</span><span>1</span></div>
                <div class="key" id="k50"><span>@</span><span>2</span></div>
                <div class="key" id="k51"><span>#</span><span>3</span></div>
                <div class="key" id="k52"><span>$</span><span>4</span></div>
                <div class="key" id="k53"><span>%</span><span>5</span></div>
                <div class="key" id="k54"><span>^</span><span>6</span></div>
                <div class="key" id="k55"><span>&</span><span>7</span></div>
                <div class="key" id="k56"><span>*</span><span>8</span></div>
                <div class="key" id="k57"><span>(</span><span>9</span></div>
                <div class="key" id="k48"><span>)</span><span>0</span></div>
                <div class="key" id="k189"><span>-</span><span>-</span></div>
                <div class="key" id="k187"><span>=</span><span>+</span></div>
                <div class="key" id="k8" style="width: 90px;">←</div>

                                <div class="key" id="k9" style="width: 70px;">Tab</div>
                <div class="key" id="k81">Q</div>
                <div class="key" id="k87">W</div>
                <div class="key" id="k69">E</div>
                <div class="key" id="k82">R</div>
                <div class="key" id="k84">T</div>
                <div class="key" id="k89">Y</div>
                <div class="key" id="k85">U</div>
                <div class="key" id="k73">I</div>
                <div class="key" id="k79">O</div>
                <div class="key" id="k80">P</div>
                <div class="key" id="k219"><span>[</span><span>{</span></div>
                <div class="key" id="k221"><span>]</span><span>}</span></div>
                <div class="key" id="k220" style="width: 60px;"><span>\</span><span>|</span></div>

                                <div class="key" id="k20" style="width: 85px;">Caps Lock</div>
                <div class="key" id="k65">A</div>
                <div class="key" id="k83">S</div>
                <div class="key" id="k68">D</div>
                <div class="key" id="k70">F</div>
                <div class="key" id="k71">G</div>
                <div class="key" id="k72">H</div>
                <div class="key" id="k74">J</div>
                <div class="key" id="k75">K</div>
                <div class="key" id="k76">L</div>
                <div class="key" id="k186"><span>;</span><span>:</span></div>
                <div class="key" id="k222"><span>'</span><span>"</span></div>
                <div class="key" id="k13" style="width: 95px;">Enter</div>

                                <div class="key" id="k16_left" style="width: 115px;">Shift</div>
                <div class="key" id="k90">Z</div>
                <div class="key" id="k88">X</div>
                <div class="key" id="k67">C</div>
                <div class="key" id="k86">V</div>
                <div class="key" id="k66">B</div>
                <div class="key" id="k78">N</div>
                <div class="key" id="k77">M</div>
                <div class="key" id="k188"><span>,</span><span><</span></div>
                <div class="key" id="k190"><span>.</span><span>></span></div>
                <div class="key" id="k191"><span>/</span><span>?</span></div>
                <div class="key" id="k16_right" style="width: 115px;">Shift</div>

                                <div class="key" id="k17_left" style="width: 50px;">Ctrl</div>
                <div class="key" id="k91" style="width: 50px;">Win</div>
                <div class="key" id="k18_left" style="width: 50px;">Alt</div>
                <div class="key" id="k32" style="width: 320px;"></div>
                <div class="key" id="k18_right" style="width: 50px;">Alt</div>
                <div class="key" id="k93" style="width: 110px;">▤</div>
                <div class="key" id="k17_right" style="width: 50px;">Ctrl</div>
            </div>

                        <div class="area-2">
                                <div class="area-2-item">
                    <div class="key" id="k44">Print</div>
                    <div class="key" id="k145">Lock</div>
                    <div class="key" id="k19">Pause</div>
                    <div class="key" id="k45">Insert</div>
                    <div class="key" id="k36">Home</div>
                    <div class="key" id="k33">UP</div>
                    <div class="key" id="k46">Del</div>
                    <div class="key" id="k35">End</div>
                    <div class="key" id="k34">Down</div>
                </div>
                                <div class="area-2-item">
                    <div class="key-empty"></div>
                    <div class="key" id="k38">↑</div>
                    <div class="key-empty"></div>
                    <div class="key" id="k37">←</div>
                    <div class="key" id="k40">↓</div>
                    <div class="key" id="k39">→</div>
                </div>
            </div>

                        <div class="area-3">
                                <div class="area-3-light">
                    <div class="area-3-light-item" style="color: orangered;">◘</div>
                    <div class="area-3-light-item">◘</div>
                    <div class="area-3-light-item">◘</div>
                    <div class="area-3-light-item">◘</div>
                </div>
                                <div class="area-3-number">
                                        <div class="area-3-number-item">
                        <div class="key" id="k144">Num</div>
                        <div class="key" id="k111">/</div>
                        <div class="key" id="k106">*</div>
                        <div class="key" id="k103">7</div>
                        <div class="key" id="k104">8</div>
                        <div class="key" id="k105">9</div>
                        <div class="key" id="k100">4</div>
                        <div class="key" id="k101">5</div>
                        <div class="key" id="k102">6</div>
                        <div class="key" id="k97">1</div>
                        <div class="key" id="k98">2</div>
                        <div class="key" id="k99">3</div>
                        <div class="key" id="k96" style="width: 90px;">0</div>
                        <div class="key" id="k110">.</div>
                    </div>
                                        <div class="area-3-number-item">
                        <div class="key" id="k109">-</div>
                        <div class="key" id="k107" style="height: 90px;">+</div>
                        <div class="key" id="k13_num" style="height: 90px;">Enter</div>
                    </div>
                </div>
            </div>
        </div>

                <div class="dashboard">
            <div class="panel">
  <div class="panel-title">Activity Heatmap </div>
  <div class="activity-split">
    <div class="activity-block">
      <div class="activity-block-title">最近 120 天（按键次数）</div>
      <div id="activityHeatmap120" class="heatmap"></div>
    </div>
    <div class="activity-block">
      <div class="activity-block-title">最近 24 小时</div>
      <div id="activityHeatmap24" class="heatmap"></div>
    </div>
  </div>
</div>

            <div class="panel">
                <div class="panel-title">Monthly Activity </div>
                <div id="monthlyHeatmap" class="heatmap"></div>
            </div>

            <div class="panel">
                <div class="panel-title">Hotkeys </div>
                <div class="hotkey-row">
                    <select id="hotkeySelect"></select>
                    <button id="refreshHotkey" class="btn">刷新</button>
                </div>
                <div id="hotkeyHeatmap" class="heatmap"></div>
                <div id="hotkeyTopList" class="hotkey-list"></div>
            </div>
        </div>

        <div id="tooltip" class="tooltip"></div>
    </div>

    <script>
        // 获取按键选择器
        const getSelector = () => {
            let selector = ''
            // 区分 shift alt control 左右键
            if ([16, 17, 18].includes(event.keyCode)) {
                selector = `#k${event.keyCode}${event.code.endsWith('Left') ? '_left' : '_right'}`
            } else {
                // 区分 enter 键
                if (event.keyCode === 13 && event.code === 'NumpadEnter') {
                    selector = `#k${event.keyCode}_num` // 数字小键盘中的 enter 键
                } else {
                    selector = `#k${event.keyCode}`
                }
            }
            return selector
        }

        // 按下
        document.addEventListener('keydown', (event) => {
            console.log({event})
            const key = document.querySelector(getSelector())
            key && key.classList.add('active')
        })

        // 松开
        document.addEventListener('keyup', (event) => {
            const key = document.querySelector(getSelector())
            if (key) {
                key.classList.remove('active')

                // 坐标点
                const position = key.getBoundingClientRect()
                const x = position.left
                const y = position.top

                // 宽 高
                const w = key.offsetWidth
                const h = key.offsetHeight

                // 创建元素并设置样式
                const div = document.createElement('div')
                div.className = 'key-bubble'
                div.innerText =  event.key.toLocaleUpperCase()
                div.style.cssText = `
                    left: ${x}px;
                    top: ${y}px;
                    opacity: .6;
                    width: ${w}px;
                    height: ${h}px;
                `
                document.body.append(div)

                // 100 毫秒后改变位置
                setTimeout(() => {
                    div.style.cssText = `
                        left: ${x}px;
                        top: ${y - 500}px;
                        opacity: 0;
                        width: ${w}px;
                        height: ${h}px;
                    `
                    setTimeout(() => div.remove(), 2050)
                }, 100)
            }
        })
    </script>

    <script>
        // 获取按键选择器
        function getId(vk,flag){
            let selector = '';
            selector = `k${vk}`;
            if(vk == 160){
                selector = `k16_left`;
            } else if (vk==161){
                selector = `k16_right`;
            }else if (vk==162){
                selector = `k17_left`;
            }else if (vk==163){
                selector = `k17_right`;
            }else if (vk==164){
                selector = `k18_left`;
            }else if (vk==165){
                selector = `k18_right`;
            }
            return selector;
        }
        function generateRGBColors(value, maxValue) {
            // 定义起始颜色和结束颜色
            const startColor = [255, 255, 255]; // 红色 (RGB)
            const endColor = [255, 0, 0]; // 蓝色 (RGB)
            n = 20;
            index = value / maxValue*n;
            // 计算当前段的比例 (从 0 到 1)
            let ratio = index / n;
            // 对每个通道进行线性插值
            let r = Math.round(startColor[0] + ratio * (endColor[0] - startColor[0]));
            let g = Math.round(startColor[1] + ratio * (endColor[1] - startColor[1]));
            let b = Math.round(startColor[2] + ratio * (endColor[2] - startColor[2]));
            return `rgb(${r}, ${g}, ${b})`;
        }
        const tooltip = document.getElementById('tooltip');

        // 获取按键点击次数并设置热力图
        async function fetchKeyCounts() {
            try {
                const response = await fetch('/key_counts');
                const keyCounts = await response.json();
                // 获取最大按键点击次数
                const maxCount = Math.max(...keyCounts.map(item => item.count));
                keyCounts.forEach(item => {
                    const id_ = getId(item.virtual_key_code,item.key_name);
                    const keyElement = document.getElementById(id_);
                    if (keyElement) {
                        const count = item.count;
                        keyElement.style.backgroundColor = generateRGBColors(count,maxCount); // 根据点击量改变键盘按键颜色
                        keyElement.addEventListener('mouseover', function(event) {
                            tooltip.textContent = `${item.count}`;
                            tooltip.style.display = 'block';
                            tooltip.style.left = event.pageX + 10 + 'px';
                            tooltip.style.top = event.pageY + 10 + 'px';
                        });

                        keyElement.addEventListener('mousemove', function(event) {
                            tooltip.style.left = event.pageX + 10 + 'px';
                            tooltip.style.top = event.pageY + 10 + 'px';
                        });

                        keyElement.addEventListener('mouseout', function() {
                            tooltip.style.display = 'none';
                        });
                    }
                });
            } catch (error) {
                console.error('Error fetching key counts:', error);
            }
        }

        // 每秒钟请求一次数据更新热力图
        setInterval(fetchKeyCounts, 1000);

        // ===== Timeline & Hotkeys (v2) =====
        function parseDateYYYYMMDD(s) {
            const [y,m,d] = s.split('-').map(x => parseInt(x, 10));
            return new Date(y, m-1, d);
        }

        function formatDateYYYYMMDD(dt) {
            const y = dt.getFullYear();
            const m = String(dt.getMonth()+1).padStart(2,'0');
            const d = String(dt.getDate()).padStart(2,'0');
            return `${y}-${m}-${d}`;
        }

        function renderDailyHeatmap(containerId, daySeries, valueKey, labelPrefix) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // 清空
            container.innerHTML = '';
            container.classList.add('heatmap');

            // 生成 date->value 映射
            const mp = {};
            let maxV = 0;
            for (const it of daySeries) {
                const v = Math.max(0, parseInt(it[valueKey] ?? it.count ?? 0, 10));
                mp[it.date] = v;
                if (v > maxV) maxV = v;
            }

            // 计算范围（基于返回数组首尾）
            const start = parseDateYYYYMMDD(daySeries[0].date);
            const end = parseDateYYYYMMDD(daySeries[daySeries.length-1].date);

            // 对齐到周日开头（GitHub 风格）
            const alignedStart = new Date(start);
            alignedStart.setDate(alignedStart.getDate() - alignedStart.getDay());

            const grid = document.createElement('div');
            grid.className = 'heatmap-grid';

            const tooltip = document.getElementById('tooltip');

            // 遍历每周
            let cursor = new Date(alignedStart);
            while (cursor <= end) {
                const week = document.createElement('div');
                week.className = 'heatmap-week';

                for (let i=0;i<7;i++) {
                    const cellDate = new Date(cursor);
                    cellDate.setDate(cellDate.getDate() + i);
                    const ds = formatDateYYYYMMDD(cellDate);
                    const cell = document.createElement('div');
                    cell.className = 'heat-cell';

                    const inRange = (cellDate >= start && cellDate <= end);
                    const v = inRange ? (mp[ds] ?? 0) : 0;

                    if (inRange && maxV > 0) {
                        cell.style.backgroundColor = generateRGBColors(v, maxV);
                    } else {
                        cell.style.backgroundColor = 'rgba(0,0,0,0.04)';
                    }

                    if (inRange) {
                        cell.addEventListener('mouseover', function(ev){
                            tooltip.textContent = `${labelPrefix}${v}  •  ${ds}`;
                            tooltip.style.display = 'block';
                            tooltip.style.left = (ev.pageX + 10) + 'px';
                            tooltip.style.top = (ev.pageY + 10) + 'px';
                        });
                        cell.addEventListener('mousemove', function(ev){
                            tooltip.style.left = (ev.pageX + 10) + 'px';
                            tooltip.style.top = (ev.pageY + 10) + 'px';
                        });
                        cell.addEventListener('mouseout', function(){
                            tooltip.style.display = 'none';
                        });
                    }

                    week.appendChild(cell);
                }

                grid.appendChild(week);
                cursor.setDate(cursor.getDate() + 7);
            }

            container.appendChild(grid);
        }

        function renderMonthlyHeatmap(containerId, monthSeries) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'heatmap-month-grid';

            let maxV = 0;
            for (const it of monthSeries) {
                const v = Math.max(0, parseInt(it.key_presses ?? 0, 10));
                if (v > maxV) maxV = v;
            }

            const tooltip = document.getElementById('tooltip');

            for (const it of monthSeries) {
                const cell = document.createElement('div');
                cell.className = 'month-cell';

                const v = Math.max(0, parseInt(it.key_presses ?? 0, 10));
                if (maxV > 0) {
                    cell.style.backgroundColor = generateRGBColors(v, maxV);
                }

                const label = document.createElement('div');
                label.className = 'month-label';
                label.textContent = it.month;

                const value = document.createElement('div');
                value.className = 'month-value';
                value.textContent = `keys: ${v}`;

                cell.appendChild(label);
                cell.appendChild(value);

                cell.addEventListener('mouseover', function(ev){
                    tooltip.textContent = `keys: ${v}  •  ${it.month}`;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (ev.pageX + 10) + 'px';
                    tooltip.style.top = (ev.pageY + 10) + 'px';
                });
                cell.addEventListener('mousemove', function(ev){
                    tooltip.style.left = (ev.pageX + 10) + 'px';
                    tooltip.style.top = (ev.pageY + 10) + 'px';
                });
                cell.addEventListener('mouseout', function(){
                    tooltip.style.display = 'none';
                });

                grid.appendChild(cell);
            }

            container.appendChild(grid);
        }

        

function renderHourlyHeatmap(containerId, hourSeries) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'hourly-grid';

    const tooltip = document.getElementById('tooltip');

    let maxV = 0;
    const items = [];
    for (const it of hourSeries) {
        const v = Math.max(0, parseInt(it.key_presses ?? it.count ?? 0, 10));
        if (v > maxV) maxV = v;
        items.push({ hour: it.hour, v });
    }

    for (const it of items) {
        const cell = document.createElement('div');
        cell.className = 'hour-cell';
        if (maxV > 0) cell.style.backgroundColor = generateRGBColors(it.v, maxV);

        cell.addEventListener('mouseover', function(ev){
            tooltip.textContent = `keys: ${it.v}  •  ${it.hour}:00`;
            tooltip.style.display = 'block';
            tooltip.style.left = (ev.pageX + 10) + 'px';
            tooltip.style.top = (ev.pageY + 10) + 'px';
        });
        cell.addEventListener('mousemove', function(ev){
            tooltip.style.left = (ev.pageX + 10) + 'px';
            tooltip.style.top = (ev.pageY + 10) + 'px';
        });
        cell.addEventListener('mouseout', function(){
            tooltip.style.display = 'none';
        });

        grid.appendChild(cell);
    }

    container.appendChild(grid);
    // 主动释放临时引用，降低长期运行的内存占用
    items.length = 0;
}

async function fetchActivityDaily() {
            try {
                const resp = await fetch('/activity_daily?days=120');
                const data = await resp.json();
                renderDailyHeatmap('activityHeatmap120', data, 'key_presses', 'keys: ');
            } catch (e) {
                console.error('Error fetching activity_daily:', e);
            }
        }

async function fetchActivityHourly() {
    try {
        const resp = await fetch('/activity_hourly?hours=24');
        const data = await resp.json();
        renderHourlyHeatmap('activityHeatmap24', data);
    } catch (e) {
        console.error('Error fetching activity_hourly:', e);
    }
}


        async function fetchActivityMonthly() {
            try {
                const resp = await fetch('/activity_monthly?months=24');
                const data = await resp.json();
                renderMonthlyHeatmap('monthlyHeatmap', data);
            } catch (e) {
                console.error('Error fetching activity_monthly:', e);
            }
        }

        function renderHotkeyTopList(items) {
            const box = document.getElementById('hotkeyTopList');
            if (!box) return;
            box.innerHTML = '';
            for (const it of items) {
                const row = document.createElement('div');
                row.className = 'hotkey-item';
                const left = document.createElement('div');
                left.textContent = it.display_name || it.hotkey_id;
                const right = document.createElement('div');
                right.textContent = it.total_count;
                row.appendChild(left);
                row.appendChild(right);
                box.appendChild(row);
            }
        }

        async function fetchHotkeyTotals() {
            try {
                const resp = await fetch('/hotkey_totals?limit=20');
                const items = await resp.json();
                renderHotkeyTopList(items);

                const sel = document.getElementById('hotkeySelect');
                if (sel && sel.options.length === 0) {
                    // “全部”：聚合所有快捷键
                    const allOpt = document.createElement('option');
                    allOpt.value = '__ALL__';
                    allOpt.textContent = '全部（All Hotkeys）';
                    sel.appendChild(allOpt);

                    for (const it of items) {
                        const opt = document.createElement('option');
                        opt.value = it.hotkey_id;
                        opt.textContent = it.display_name || it.hotkey_id;
                        sel.appendChild(opt);
                    }
                }
                return items;
            } catch (e) {
                console.error('Error fetching hotkey_totals:', e);
                return [];
            }
        }

        async function fetchHotkeySeries() {
            const sel = document.getElementById('hotkeySelect');
            const hotkeyId = sel ? sel.value : '';
            if (!hotkeyId) {
                document.getElementById('hotkeyHeatmap').innerHTML = '<div class="subtle">暂无快捷键数据</div>';
                return;
            }
            try {
                const resp = await fetch(`/hotkey_series?hotkey_id=${encodeURIComponent(hotkeyId)}&days=120`);
                const data = await resp.json();
                renderDailyHeatmap('hotkeyHeatmap', data, 'count', 'count: ');
            } catch (e) {
                console.error('Error fetching hotkey_series:', e);
            }
        }

        document.getElementById('refreshHotkey')?.addEventListener('click', async () => {
            await fetchHotkeyTotals();
            await fetchHotkeySeries();
        });

        document.getElementById('hotkeySelect')?.addEventListener('change', async () => {
            await fetchHotkeySeries();
        });

        // 首次加载
        fetchActivityDaily();
        fetchActivityHourly();
        fetchActivityMonthly();
        fetchHotkeyTotals().then(() => fetchHotkeySeries());

        // 定时刷新（频率低一点）
        setInterval(fetchActivityDaily, 10_000);
        setInterval(fetchActivityHourly, 10_000);
        setInterval(fetchActivityMonthly, 60_000);
        setInterval(fetchHotkeyTotals, 30_000);
        setInterval(fetchHotkeySeries, 30_000);
    </script>
</body>
</html>
